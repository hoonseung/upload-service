<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sewon.uploadservice.repository.erp.ERPStockMapper">

  <select id="findStockSummary" resultType="ERPStockRecord">
    WITH summary AS (
    SELECT SiteCode AS 장소, location AS 저장위치, PrdCategory AS 제품군, PartNo, QTY
    FROM TB_PRD_수불마감_월
    WHERE YYYYMM = FORMAT(DATEADD(M, -2, #{date}), 'yyyyMM')
    AND SiteCode = #{site}
    AND Location = #{location}
    AND PrdCategory = #{category}
    AND PartNo = #{partNo}

    UNION ALL
-- inbound
    SELECT [참조 사이트] AS 장소, TO_Location AS 저장위치, 제품군, [품목 번호], SUM(-[Loc 수량 변화])
    FROM TB_QAD_수불이력찾아보기_NEW
    WHERE 유효일 BETWEEN DATEADD(D, 1, EOMONTH(#{date}, -2)) AND #{date}
    AND [참조 사이트] = #{site}
    AND TO_LOCATION = #{location}
    AND 제품군 = #{category}
    AND [품목 번호] = #{partNo}
    AND ([관련사이트/저장위치] LIKE '%으로%' OR [관련사이트/저장위치] = ':')
    AND [Loc 수량 변화] != 0
    AND [출하 유형] NOT IN ('S','M')
    GROUP BY [참조 사이트], TO_Location, 제품군, [품목 번호]

    UNION ALL
-- outbound
    SELECT 장소 AS 장소, [저장 위치] AS 저장위치, 제품군, [품목 번호], SUM([Loc 수량 변화])
    FROM TB_QAD_수불이력찾아보기_NEW
    WHERE 유효일 BETWEEN DATEADD(D, 1, EOMONTH(#{date}, -2)) AND #{date}
    AND 장소 = #{site}
    AND [저장 위치] = #{location}
    AND 제품군 = #{category}
    AND [품목 번호] = #{partNo}
    AND ([관련사이트/저장위치] LIKE '%으로%' OR [관련사이트/저장위치] = ':')
    AND [Loc 수량 변화] != 0
    AND [출하 유형] NOT IN ('S','M')
    GROUP BY 장소, [저장 위치], 제품군, [품목 번호]
    )
    SELECT 장소, 저장위치, 제품군, PartNo, SUM(ISNULL(qty,0)) AS 기말재고,
           #{date} AS 날짜
    FROM summary
    GROUP BY 장소, 저장위치, 제품군, PartNo
    HAVING SUM(ISNULL(qty,0)) != 0
  </select>
</mapper>
